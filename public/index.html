<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
    <div x-data="queueSystem()" x-init="init()" class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-red-500 mb-2">
                <i class="fas fa-music mr-2"></i>YouTube Music Queue
            </h1>
            <p class="text-gray-400">Auto-play system dengan antrian berdasarkan durasi lagu</p>
        </div>
        
        <!-- Current Status -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Status Saat Ini</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Current Song -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-green-400">ðŸŽµ Lagu yang Diputar</h3>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <div class="text-2xl font-bold truncate" x-text="currentSong.title || 'Tidak ada lagu'"></div>
                        <div class="text-gray-400 truncate" x-text="currentSong.artist || 'Unknown artist'"></div>
                        <div class="mt-2 text-sm">
                            <span>Durasi: </span>
                            <span class="font-mono" x-text="formatDuration(currentSong.duration)"></span>
                            <span class="text-gray-500 ml-2" x-text="'(' + currentSong.confidence + '% confidence)'"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Active Request -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-yellow-400">ðŸŽ¯ Request Aktif</h3>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <div x-show="queueInfo.currentRequest">
                            <div class="text-xl font-bold truncate" x-text="queueInfo.currentRequest.query"></div>
                            <div class="text-sm text-gray-400 mt-1">
                                Ditambahkan: <span x-text="formatTime(queueInfo.currentRequest.time)"></span>
                            </div>
                        </div>
                        <div x-show="!queueInfo.currentRequest" class="text-gray-500 italic">
                            Tidak ada request aktif
                        </div>
                        
                        <!-- Lock Status -->
                        <div class="mt-4">
                            <div x-show="queueInfo.isLocked" class="text-yellow-400 bg-yellow-900/20 p-3 rounded-lg">
                                <i class="fas fa-lock mr-2"></i>
                                <span>Terkunci: </span>
                                <span x-text="queueInfo.remainingFormatted"></span>
                            </div>
                            <div x-show="!queueInfo.isLocked" class="text-green-400 bg-green-900/20 p-3 rounded-lg">
                                <i class="fas fa-unlock mr-2"></i>
                                <span>Siap untuk request berikutnya</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Queue Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-xl text-center">
                <div class="text-3xl font-bold" x-text="queueInfo.queueLength"></div>
                <div class="text-gray-400 text-sm">Dalam Antrian</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl text-center">
                <div class="text-3xl font-bold" x-text="queueInfo.totalQueueTime || '0'"></div>
                <div class="text-gray-400 text-sm">Estimasi Total (menit)</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl text-center">
                <div class="text-3xl font-bold" x-text="queueInfo.queueLength > 0 ? '1' : '0'"></div>
                <div class="text-gray-400 text-sm">Sedang Diproses</div>
            </div>
        </div>
        
        <!-- Add Request Form -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Tambah Request Lagu</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input x-model="newQuery" @keydown.enter="addRequest()"
                    placeholder="Masukkan judul lagu atau nama artis..."
                    class="flex-1 bg-gray-900 border border-gray-700 p-3 rounded-lg focus:outline-none focus:border-red-500">
                
                <button @click="addRequest()"
                    class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold transition-colors">
                    <i class="fas fa-plus mr-2"></i>Tambah ke Antrian
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-3">
                <i class="fas fa-info-circle mr-1"></i>
                Lagu akan diputar otomatis oleh extension YouTube Music
            </p>
        </div>
        
        <!-- Queue List -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Daftar Antrian</h2>
                <div class="text-sm text-gray-400" x-text="queueInfo.queueLength + ' lagu'"></div>
            </div>
            
            <!-- Empty State -->
            <div x-show="queueInfo.queueLength === 0" 
                 class="text-center py-8 border-2 border-dashed border-gray-700 rounded-lg">
                <i class="fas fa-music text-4xl text-gray-600 mb-4"></i>
                <p class="text-gray-400">Antrian kosong</p>
                <p class="text-gray-500 text-sm mt-1">Tambahkan lagu di atas</p>
            </div>
            
            <!-- Queue Items -->
            <div class="space-y-3" x-show="queueInfo.queueLength > 0">
                <template x-for="(req, index) in queueInfo.queue" :key="req.id">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <!-- Position Number -->
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-500" x-text="req.position"></div>
                                    <div class="text-xs text-gray-600">#</div>
                                </div>
                                
                                <!-- Request Info -->
                                <div>
                                    <div class="font-bold text-lg truncate max-w-md" x-text="req.query"></div>
                                    <div class="text-sm text-gray-400 mt-1">
                                        <span>Ditambahkan: </span>
                                        <span x-text="formatTime(req.time)"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div>
                                <button @click="removeRequest(req.id)"
                                        class="text-gray-500 hover:text-red-400 p-2 rounded-lg hover:bg-gray-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Queue Controls -->
            <div class="flex gap-3 mt-6" x-show="queueInfo.queueLength > 0">
                <button @click="skipCurrent()"
                        class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-3 rounded-lg font-bold transition-colors">
                    <i class="fas fa-forward mr-2"></i>Skip Request Saat Ini
                </button>
                <button @click="clearAll()"
                        class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-bold transition-colors">
                    <i class="fas fa-trash mr-2"></i>Hapus Semua
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <div class="flex items-center justify-center gap-4 mb-2">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span>Server: <span id="server-status">Connected</span></span>
                </div>
                <div>â€¢</div>
                <div>YouTube Music Bridge v2.0</div>
            </div>
            <p>Extension akan memutar lagu secara otomatis berdasarkan durasi</p>
        </div>
    </div>

    <script>
        function queueSystem() {
            return {
                currentSong: { title: '', artist: '', duration: 0, confidence: 0 },
                queueInfo: {
                    isLocked: false,
                    remainingFormatted: '0 detik',
                    currentRequest: null,
                    queue: [],
                    queueLength: 0,
                    totalQueueTime: 0
                },
                newQuery: '',
                
                async init() {
                    // Load initial data
                    await this.fetchData();
                    
                    // Set up periodic updates
                    setInterval(async () => {
                        await this.fetchData();
                    }, 2000);
                    
                    // Update server status
                    setInterval(this.checkServerStatus, 5000);
                },
                
                async fetchData() {
                    try {
                        // Get current song
                        const statusRes = await fetch('/status');
                        this.currentSong = await statusRes.json();
                        
                        // Get queue info
                        const queueRes = await fetch('/queue-info');
                        this.queueInfo = await queueRes.json();
                        
                        // Update server status
                        document.getElementById('server-status').textContent = 'Connected';
                        document.getElementById('server-status').className = 'text-green-400';
                        
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        document.getElementById('server-status').textContent = 'Disconnected';
                        document.getElementById('server-status').className = 'text-red-400';
                    }
                },
                
                async addRequest() {
                    if (!this.newQuery.trim()) {
                        alert('Masukkan judul lagu atau nama artis');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/request-song', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ query: this.newQuery })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            this.newQuery = '';
                            await this.fetchData();
                            this.showToast(`Ditambahkan ke antrian (Posisi: ${result.queuePosition})`, 'success');
                        } else {
                            this.showToast(`Error: ${result.error}`, 'error');
                        }
                    } catch (error) {
                        this.showToast('Gagal menambahkan request', 'error');
                    }
                },
                
                async removeRequest(id) {
                    if (!confirm('Hapus request ini dari antrian?')) return;
                    
                    try {
                        const response = await fetch(`/remove-request/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            await this.fetchData();
                            this.showToast(`Dihapus: ${result.removed}`, 'success');
                        }
                    } catch (error) {
                        this.showToast('Gagal menghapus request', 'error');
                    }
                },
                
                async skipCurrent() {
                    try {
                        const response = await fetch('/skip-current', {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            await this.fetchData();
                            this.showToast('Request berhasil diskip', 'success');
                        }
                    } catch (error) {
                        this.showToast('Gagal skip request', 'error');
                    }
                },
                
                async clearAll() {
                    if (this.queueInfo.queueLength === 0) {
                        alert('Antrian sudah kosong');
                        return;
                    }
                    
                    if (!confirm(`Hapus semua ${this.queueInfo.queueLength} request dari antrian?`)) return;
                    
                    try {
                        const response = await fetch('/clear-requests', {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            await this.fetchData();
                            this.showToast(`Dihapus ${result.clearedCount} request`, 'success');
                        }
                    } catch (error) {
                        this.showToast('Gagal menghapus antrian', 'error');
                    }
                },
                
                formatDuration(ms) {
                    if (!ms) return '0:00';
                    const seconds = Math.round(ms / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },
                
                checkServerStatus() {
                    fetch('/status').then(() => {
                        document.getElementById('server-status').textContent = 'Connected';
                        document.getElementById('server-status').className = 'text-green-400';
                    }).catch(() => {
                        document.getElementById('server-status').textContent = 'Disconnected';
                        document.getElementById('server-status').className = 'text-red-400';
                    });
                },
                
                showToast(message, type = 'info') {
                    // Simple toast notification
                    const toast = document.createElement('div');
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg font-medium text-white z-50 transform transition-all duration-300 ${
                        type === 'success' ? 'bg-green-600' : 
                        type === 'error' ? 'bg-red-600' : 'bg-gray-700'
                    }`;
                    toast.textContent = message;
                    
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                }
            }
        }
        
        // Initial server check
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/status').then(() => {
                document.getElementById('server-status').textContent = 'Connected';
                document.getElementById('server-status').className = 'text-green-400';
            }).catch(() => {
                document.getElementById('server-status').textContent = 'Disconnected';
                document.getElementById('server-status').className = 'text-red-400';
            });
        });
    </script>
</body>
</html>